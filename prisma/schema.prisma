// Sesame3 Database Schema
// Using Prisma with PostgreSQL (Supabase)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // For migrations (Supabase pooling)
}

// =============================================================================
// LAYER 1: IDENTITY & AUTH
// =============================================================================

// -----------------------------------------------------------------------------
// AuthCode - OTP Codes for Email Verification
// -----------------------------------------------------------------------------

model AuthCode {
  id        String   @id @default(uuid())
  email     String
  code      String   // 6-digit code
  type      String   @default("login") // "login" | "signup" | "password_reset"

  // Security
  attempts  Int      @default(0)  // Failed verification attempts
  maxAttempts Int    @default(5)  // Lock after this many attempts

  // Lifecycle
  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())

  @@index([email])
  @@index([expiresAt])
}

// -----------------------------------------------------------------------------
// RefreshToken - Mobile App Token Management
// -----------------------------------------------------------------------------

model RefreshToken {
  id        String    @id // Token ID (jti from JWT)
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  expiresAt DateTime
  revokedAt DateTime? // Set when token is revoked/rotated

  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  avatarUrl String?

  // Auth metadata
  authProvider   String?  // "email" | "google" | "apple"
  emailVerified  Boolean  @default(false)
  lastLoginAt    DateTime?

  // Account type - who is this user?
  accountType    String   @default("student")  // "student" | "parent" | "counselor"

  // Preferences
  preferences Json?    // { theme, notifications, etc. }

  // Notification preferences (free-form text, interpreted by LLM)
  // e.g., "Don't message me on weekends" or "Only send deadline reminders"
  notificationPreferences String?   @db.Text
  
  // ==========================================================================
  // SUBSCRIPTION & USAGE
  // ==========================================================================
  
  // Subscription Tier
  subscriptionTier    String    @default("free")  // "free" | "standard" | "premium"
  subscriptionEndsAt  DateTime?                   // When current subscription expires
  stripeCustomerId    String?                     // For payment processing (future)
  stripeSubscriptionId String?                    // Active Stripe subscription (future)
  
  // Admin Overrides (set via admin panel)
  // These override the global tier limits if set
  overrideDailyCostLimit  Float?   // Max $ per day (null = use global default)
  overrideWeeklyCostLimit Float?   // Max $ per week (null = use global default)
  overrideMessageLimit    Int?     // Max messages per day (null = use global default)
  isAdmin                 Boolean  @default(false)  // Admin flag for admin panel access
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  studentProfile    StudentProfile?
  accessGrantsGiven AccessGrant[]    @relation("GrantedBy")
  accessGrantsReceived AccessGrant[] @relation("GrantedTo")
  usageRecords      UsageRecord[]
  invitationsSent   Invitation[]
  refreshTokens     RefreshToken[]

  // Future: Organization membership
  organizationMemberships OrganizationMember[]

  // Notifications received
  notifications Notification[]
}

// =============================================================================
// LAYER 2: STUDENT PROFILE (Core Data)
// =============================================================================

model StudentProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Basic Info
  firstName      String
  lastName       String?
  preferredName  String?   // What they want to be called
  
  // Academic Context
  grade           String?   // "9th" | "10th" | "11th" | "12th" | "gap_year"
  graduationYear  Int?
  highSchoolName  String?
  highSchoolCity  String?
  highSchoolState String?
  highSchoolType  String?   // "public" | "private" | "charter" | "homeschool"

  // Personal Info (for eligibility calculations)
  birthDate         DateTime?   // For age-based program eligibility
  residencyStatus   String?     // "us_citizen" | "us_permanent_resident" | "international"

  // Onboarding State
  onboardingCompletedAt DateTime?
  onboardingData        Json?     // Captured during onboarding flow
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations - Profile Components
  aboutMe     AboutMe?
  academics   Academics?
  testing     Testing?
  courses     Course[]
  activities  Activity[]
  awards      Award[]
  programs    Program[]
  
  // Relations - Planning
  goals               Goal[]
  tasks               Task[]
  schoolList          StudentSchool[]
  summerProgramList   StudentSummerProgram[]

  // Relations - AI
  conversations   Conversation[]
  studentContext  StudentContext?
  dataRequests    DataRequest[]

  // Relations - Access Control
  accessGrants AccessGrant[]
  invitations  Invitation[]

  // Relations - Recommendations
  recommendationPreferences RecommendationPreferences?
  recommendations           Recommendation[]

  @@index([userId])
}

// -----------------------------------------------------------------------------
// About Me - Personal Narrative
// -----------------------------------------------------------------------------

model AboutMe {
  id               String @id @default(uuid())
  studentProfileId String @unique
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  
  // Identity (synthesized from story entries)
  values      String[]  // ["curiosity", "equity", "creativity"]
  interests   String[]  // ["robotics", "philosophy", "music"]
  personality String?   // "curious introvert who loves teaching"
  
  // Background
  background   String?  // Family, cultural context
  aspirations  String?  // What they want to become
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  storyEntries StoryEntry[]
}

// -----------------------------------------------------------------------------
// Story Entries - Journal-like personal narrative entries
// Students share stories over time, building a rich picture of who they are.
// -----------------------------------------------------------------------------

model StoryEntry {
  id        String @id @default(uuid())
  aboutMeId String
  aboutMe   AboutMe @relation(fields: [aboutMeId], references: [id], onDelete: Cascade)
  
  // AI-Generated Summary (from conversation or note)
  title     String    // "Learning to Lead Through Failure"
  summary   String    // 2-3 sentence summary
  themes    String[]  // ["Growth", "Leadership", "Challenge"]
  
  // Raw Content
  rawContent    String    // Original conversation transcript or note text
  contentType   String    // "conversation" | "note"
  
  // For conversation mode: the conversation ID (optional link)
  conversationId String?
  
  // Timestamps
  capturedAt    DateTime  @default(now())  // When the story was shared
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([aboutMeId])
  @@index([capturedAt])
}

// -----------------------------------------------------------------------------
// Academics - GPA & Overview
// GPA is CALCULATED from courses. School-reported values stored for reference.
// -----------------------------------------------------------------------------

model Academics {
  id               String @id @default(uuid())
  studentProfileId String @unique
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  
  // School-reported GPA (optional - for reference if different from calculated)
  // NOTE: Primary GPA should be CALCULATED from courses
  schoolReportedGpaUnweighted  Float?   // What school transcript shows (0.0 - 4.0)
  schoolReportedGpaWeighted    Float?   // What school transcript shows (can be > 4.0)
  gpaScale                     Float?   // School's GPA scale (usually 4.0 or 5.0)
  
  // Class Standing
  classRank        Int?
  classSize        Int?
  
  // Transcript
  transcriptUrl    String?  // If uploaded
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -----------------------------------------------------------------------------
// Courses - Individual Classes (Completed, In-Progress, Planned)
// -----------------------------------------------------------------------------

model Course {
  id               String @id @default(uuid())
  studentProfileId String
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  
  // Course Info
  name        String    // "AP Calculus BC"
  subject     String?   // "Math" | "Science" | "English" | "History" | "Language" | "Arts" | "Other"
  
  // Rigor Level
  level       String?   // "regular" | "honors" | "ap" | "ib" | "college" | "other"
  
  // Temporal Status
  status      String    // "completed" | "in_progress" | "planned"
  
  // When
  academicYear  String?   // "2023-2024"
  semester      String?   // "fall" | "spring" | "full_year" | "summer"
  gradeLevel    String?   // "9th" | "10th" | "11th" | "12th" - when they took/will take it
  
  // Performance (for completed/in-progress)
  grade         String?   // "A" | "A-" | "B+" etc. or null if planned
  gradeNumeric  Float?    // 4.0, 3.7, etc.
  
  // For planned courses - why they want to take it
  planningNotes String?
  
  // Metadata
  isCore        Boolean @default(false)  // Core subject vs elective
  credits       Float?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([studentProfileId])
  @@index([status])
}

// -----------------------------------------------------------------------------
// Testing - Standardized Test Scores (Multiple Attempts Supported)
// -----------------------------------------------------------------------------

// Container model for all testing data (one per student)
model Testing {
  id               String @id @default(uuid())
  studentProfileId String @unique
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  
  // Test Plans (for advising)
  planningToTakeSat     Boolean @default(false)
  planningToTakeAct     Boolean @default(false)
  plannedSatDate        DateTime?
  plannedActDate        DateTime?
  
  // PSAT/NMSQT (usually just one)
  psatTotal       Int?
  psatMath        Int?
  psatReading     Int?
  psatDate        DateTime?
  nmsqtQualified  Boolean?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Multiple test attempts
  satScores     SATScore[]
  actScores     ACTScore[]
  apScores      APScore[]
  subjectTests  SubjectTest[]   // SAT Subject Tests (SAT II)
}

// SAT Score - Multiple attempts supported
model SATScore {
  id        String  @id @default(uuid())
  testingId String
  testing   Testing @relation(fields: [testingId], references: [id], onDelete: Cascade)
  
  // Scores
  total     Int       // 400-1600 (calculated from sections)
  math      Int       // 200-800
  reading   Int       // 200-800 (Evidence-Based Reading & Writing)
  
  // Optional sections
  essay     Int?      // 2-8 (if taken)
  
  // Date
  testDate  DateTime
  
  // Flags
  isSuperscored  Boolean @default(false)  // Is this the superscore?
  isPrimary      Boolean @default(false)  // Show this as the main score?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([testingId])
}

// ACT Score - Multiple attempts supported
model ACTScore {
  id        String  @id @default(uuid())
  testingId String
  testing   Testing @relation(fields: [testingId], references: [id], onDelete: Cascade)
  
  // Scores
  composite Int       // 1-36 (average of sections)
  english   Int       // 1-36
  math      Int       // 1-36
  reading   Int       // 1-36
  science   Int       // 1-36
  
  // Optional
  writing   Int?      // 2-12 (if taken)
  
  // Date
  testDate  DateTime
  
  // Flags
  isSuperscored  Boolean @default(false)  // Is this the superscore?
  isPrimary      Boolean @default(false)  // Show this as the main score?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([testingId])
}

// AP Exam Scores
model APScore {
  id        String  @id @default(uuid())
  testingId String
  testing   Testing @relation(fields: [testingId], references: [id], onDelete: Cascade)
  
  subject   String    // "Calculus BC", "Physics C: Mechanics"
  score     Int       // 1-5
  year      Int       // Year taken (e.g., 2024)
  
  createdAt DateTime @default(now())
  
  @@index([testingId])
}

// SAT Subject Tests (SAT II) - Discontinued but still reportable
model SubjectTest {
  id        String  @id @default(uuid())
  testingId String
  testing   Testing @relation(fields: [testingId], references: [id], onDelete: Cascade)
  
  subject   String    // "Math Level 2", "Chemistry", "Physics"
  score     Int       // 200-800
  testDate  DateTime?
  
  createdAt DateTime @default(now())
  
  @@index([testingId])
}

// -----------------------------------------------------------------------------
// Activities - Extracurriculars
// -----------------------------------------------------------------------------

model Activity {
  id               String @id @default(uuid())
  studentProfileId String
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  
  // Basic Info
  title        String    // "President" | "Member" | "Volunteer"
  organization String    // "Robotics Club" | "Local Hospital"
  
  // Category
  category     String?   // "club" | "sport" | "arts" | "volunteer" | "work" | "family" | "other"
  
  // Duration
  yearsActive  String?   // "9th-11th" or "2021-2023"
  startGrade   String?   // "9th"
  endGrade     String?   // "11th" or "present"
  
  // Time Commitment
  hoursPerWeek     Float?
  weeksPerYear     Int?
  
  // Details
  description      String?   // Impact, responsibilities
  achievements     String?   // Specific accomplishments
  
  // Flags
  isLeadership     Boolean @default(false)
  isSpike          Boolean @default(false)  // Marked as their "spike" activity
  isContinuing     Boolean @default(true)   // Still doing it
  
  // Order for display
  displayOrder     Int     @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([studentProfileId])
}

// -----------------------------------------------------------------------------
// Awards - Honors & Recognition
// -----------------------------------------------------------------------------

model Award {
  id               String @id @default(uuid())
  studentProfileId String
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  
  // Basic Info
  title        String    // "AIME Qualifier"
  organization String?   // "MAA" | "College Board"
  
  // Classification
  level        String    // "school" | "regional" | "state" | "national" | "international"
  category     String?   // "academic" | "arts" | "athletics" | "community" | "other"
  
  // When
  year         Int?
  gradeLevel   String?   // When they received it
  
  // Details
  description  String?
  
  // Order for display
  displayOrder Int @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([studentProfileId])
}

// -----------------------------------------------------------------------------
// Programs - Summer, Research, Internships
// -----------------------------------------------------------------------------

model Program {
  id               String @id @default(uuid())
  studentProfileId String
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  
  // Basic Info
  name         String    // "Stanford SIMR"
  organization String?   // "Stanford Medicine"
  
  // Type
  type         String    // "summer" | "research" | "internship" | "online" | "competition_prep" | "other"
  
  // Status
  status       String    // "interested" | "applying" | "applied" | "accepted" | "rejected" | "waitlisted" | "attending" | "completed"
  
  // Timing
  year         Int?
  startDate    DateTime?
  endDate      DateTime?
  duration     String?   // "2 weeks" | "6 weeks" | "semester"
  
  // Application
  applicationDeadline DateTime?
  applicationStatus   String?   // Notes on where they are in the process
  
  // Details
  description  String?
  selectivity  String?   // "highly_selective" | "selective" | "moderate" | "open"
  
  // Outcome (if completed)
  outcome      String?   // What they accomplished
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([studentProfileId])
  @@index([status])
}

// =============================================================================
// LAYER 3: SCHOOLS & PLANNING
// =============================================================================

// -----------------------------------------------------------------------------
// School - Reference Data (Curated, shared across students)
// -----------------------------------------------------------------------------

model School {
  id            String @id @default(uuid())

  // Basic Info
  name          String    @unique

  // Location
  city          String?
  state         String?
  country       String   @default("USA")

  // Type
  type          String?   // "private" | "public" | "liberal_arts"

  // =========================================================================
  // ADMISSION TYPES - Flags for what application options the school offers
  // These are relatively stable year-over-year
  // =========================================================================

  hasEarlyDecision       Boolean  @default(false)  // ED: Binding commitment
  hasEarlyDecisionII     Boolean  @default(false)  // ED2: Later binding round
  hasEarlyAction         Boolean  @default(false)  // EA: Non-binding early
  isRestrictiveEarlyAction Boolean @default(false) // REA/SCEA: EA with restrictions
  hasRollingAdmissions   Boolean  @default(false)  // Rolling: Decisions on a rolling basis
  admissionsNotes        String?                   // Special notes about admissions process

  // =========================================================================
  // ADMISSIONS STATS (from College Scorecard)
  // =========================================================================

  acceptanceRate     Float?   // 0.0 - 1.0
  satRange25         Int?     // 25th percentile
  satRange75         Int?     // 75th percentile
  actRange25         Int?
  actRange75         Int?

  // Size
  undergradEnrollment Int?

  // Costs
  tuition            Int?
  roomBoard          Int?
  avgFinancialAid    Int?

  // Links
  websiteUrl         String?

  // =========================================================================
  // NOTES - Freeform information dump for LLM context
  // =========================================================================

  notes              String?   @db.Text  // Large freeform notes field for LLM context

  // Metadata
  lastUpdated        DateTime  @default(now())
  dataSource         String?   // "college_scorecard" | "manual" | "common_data_set"
  dataStatus         String?   // "pending_review" | "verified" | "needs_update"

  // Relations
  studentSchools  StudentSchool[]
  goals           Goal[]
  tasks           Task[]
  taskTemplates   TaskTemplate[]
  deadlineYears   SchoolDeadlineYear[]
  recommendations Recommendation[]

  @@index([name])
}

// -----------------------------------------------------------------------------
// SchoolDeadlineYear - Year-specific deadline data for schools
// Deadlines change every year. This table stores historical and current deadlines.
// -----------------------------------------------------------------------------

model SchoolDeadlineYear {
  id              String @id @default(uuid())
  schoolId        String
  school          School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Admissions cycle (e.g., 2025 means Fall 2025 enrollment, applying in 2024-2025)
  admissionsCycle Int

  // =========================================================================
  // APPLICATION DEADLINES
  // Note: REA uses deadlineEa + School.isRestrictiveEarlyAction flag
  // Note: Commitment deadline is always May 1 (National Decision Day)
  // =========================================================================

  deadlineEd           DateTime?  // Early Decision
  deadlineEd2          DateTime?  // Early Decision II
  deadlineEa           DateTime?  // Early Action (also REA if School.isRestrictiveEarlyAction)
  deadlineRd           DateTime?  // Regular Decision
  deadlinePriority     DateTime?  // Priority deadline for rolling schools
  deadlineFinancialAid DateTime?  // CSS Profile / FAFSA priority deadline

  // =========================================================================
  // DATA QUALITY
  // =========================================================================

  dataSource      String?   // "website" | "common_data_set" | "llm_scraped" | "manual"
  dataConfidence  String?   // "high" | "medium" | "low"
  sourceUrl       String?   // Where the data was found
  lastVerified    DateTime? // When admin last verified this data
  verifiedById    String?   // Admin who verified

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([schoolId, admissionsCycle])
  @@index([admissionsCycle])
}

// -----------------------------------------------------------------------------
// SummerProgram - Reference Data (Curated, shared across students)
// Programs are updated in place each year - students track via applicationYear
// Variations (residential vs commuter) are separate program records
// -----------------------------------------------------------------------------

model SummerProgram {
  id            String @id @default(uuid())

  // Basic Info
  name          String    // "Columbia Summer Immersion - Residential"
  shortName     String?   // "Columbia Residential"
  organization  String    // "Columbia University"
  description   String?   @db.Text
  websiteUrl    String?

  // Program Year (update in place each cycle)
  programYear   Int       // 2025, 2026, etc. - current year's data

  // =========================================================================
  // ELIGIBILITY - Auto-checkable criteria (for fast SQL filtering)
  // =========================================================================

  // Grade eligibility (entering grade OR during program - specify in notes)
  minGrade      Int?      // 9, 10, 11, 12
  maxGrade      Int?      // For programs like "juniors and seniors only"

  // Age eligibility (approximation for filtering, specifics in eligibilityNotes)
  minAge        Int?      // 14, 15, 16...
  maxAge        Int?      // Some programs cap at 17 or 18

  // Academic requirements
  minGpaUnweighted  Float?    // 3.5
  minGpaWeighted    Float?    // 4.0

  // Citizenship
  citizenship   String?   // "us_only" | "us_permanent_resident" | "international_ok"

  // =========================================================================
  // ELIGIBILITY - Course prerequisites (can check against student courses)
  // =========================================================================

  requiredCourses     String[]  // ["AP Calculus BC", "Chemistry", "Physics"]
  recommendedCourses  String[]  // ["AP Physics C", "Linear Algebra"]

  // =========================================================================
  // ELIGIBILITY - Complex requirements (AI interprets these)
  // =========================================================================

  // Freeform notes for complex eligibility rules the system can't auto-check
  // e.g., "Students who are 15 must turn 16 by December 31 of the year they attend"
  // e.g., "Must identify as female", "First-generation only", "Title I school"
  eligibilityNotes    String?   @db.Text

  // =========================================================================
  // APPLICATION
  // =========================================================================

  applicationOpens    DateTime?   // When applications open (for hyper-prepared families)
  applicationDeadline DateTime?   // Primary deadline
  isRolling           Boolean     @default(false)  // Rolling admissions?
  rollingNotes        String?     // "Until filled", "Rolling through March 1"
  applicationUrl      String?     // Direct link to application

  // Freeform notes about application requirements
  // e.g., "Requires 2 teacher recommendations, transcript, and 500-word essay"
  applicationNotes    String?     @db.Text

  // =========================================================================
  // PROGRAM DETAILS
  // =========================================================================

  format        String?   // "residential" | "commuter" | "online" | "hybrid"
  location      String?   // "New York, NY" | "Stanford, CA" | "Online"

  // Sessions are stored in SummerProgramSession child table
  // This allows programs with multiple sessions (June vs July)

  // =========================================================================
  // AI CONTEXT
  // =========================================================================

  // Freeform context for AI advisor to use when making recommendations
  // e.g., tracks/courses offered, notable alumni, tips for application
  // e.g., "Offers Business, Architecture, and Engineering tracks. Business track is best for students interested in entrepreneurship."
  llmContext    String?   @db.Text

  // =========================================================================
  // METADATA
  // =========================================================================

  category      String?   // "STEM" | "research" | "arts" | "leadership" | "business" | "humanities"
  focusAreas    String[]  // ["STEM", "research", "medicine", "biology", "engineering"]

  isActive      Boolean   @default(true)   // Is this program still running?
  lastVerified  DateTime?                  // When we last verified the info
  dataSource    String?                    // "manual" | "website" | "llm_scraped"
  dataStatus    String?                    // "pending_review" | "verified" | "needs_update"

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  sessions        SummerProgramSession[]
  studentPrograms StudentSummerProgram[]
  goals           Goal[]
  tasks           Task[]
  taskTemplates   TaskTemplate[]
  recommendations Recommendation[]

  @@unique([name, programYear])  // Same program can have multiple year entries
  @@index([programYear])
  @@index([applicationDeadline])
  @@index([minGrade, maxGrade])
  @@index([isActive])
  @@index([category])
}

// -----------------------------------------------------------------------------
// SummerProgramSession - Program sessions within a year
// A program can have multiple sessions (e.g., June session, July session)
// -----------------------------------------------------------------------------

model SummerProgramSession {
  id              String @id @default(uuid())
  summerProgramId String
  summerProgram   SummerProgram @relation(fields: [summerProgramId], references: [id], onDelete: Cascade)

  name            String    // "Session 1", "Summer A", "June Session"
  startDate       DateTime
  endDate         DateTime

  // Optional notes about this specific session
  notes           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([summerProgramId])
  @@index([startDate])
}

// -----------------------------------------------------------------------------
// StudentSummerProgram - Student's tracked summer programs
// Junction table between StudentProfile and SummerProgram
// -----------------------------------------------------------------------------

model StudentSummerProgram {
  id                String @id @default(uuid())
  studentProfileId  String
  studentProfile    StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)

  // Linked program from our curated database (null for custom programs)
  summerProgramId   String?
  summerProgram     SummerProgram? @relation(fields: [summerProgramId], references: [id], onDelete: Cascade)

  // Custom program fields (for programs not in our database)
  isCustom          Boolean   @default(false)
  customName        String?   // e.g., "Local Hospital Internship"
  customOrganization String?  // e.g., "St. Mary's Hospital"
  customDescription String?   @db.Text  // Brief description of the program

  // Which year they're tracking/applying for
  applicationYear   Int

  // Status tracking
  status            String  @default("interested")
  // "interested" | "researching" | "preparing" | "applying" | "applied"
  // | "accepted" | "rejected" | "waitlisted" | "declined" | "attending" | "completed"

  // Student's notes
  notes             String?   @db.Text
  whyInterested     String?   // Why this program

  // Application tracking
  applicationStarted  DateTime?
  applicationSubmitted DateTime?
  decisionReceived    DateTime?

  // Outcome (if completed)
  outcome           String?   @db.Text  // What they accomplished, for profile

  // Link to related goal (optional)
  relatedGoalId     String?   // If they created a goal for this application

  // Display
  displayOrder      Int       @default(0)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Unique constraint for linked programs only
  @@unique([studentProfileId, summerProgramId, applicationYear])
  @@index([studentProfileId])
  @@index([status])
  @@index([applicationYear])
}

// -----------------------------------------------------------------------------
// StudentSchool - Student's School List
// -----------------------------------------------------------------------------

model StudentSchool {
  id               String @id @default(uuid())
  studentProfileId String
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)

  // Linked school from our curated database (null for custom schools)
  schoolId         String?
  school           School? @relation(fields: [schoolId], references: [id])

  // Custom school fields (for schools not in our database)
  isCustom         Boolean   @default(false)
  customName       String?   // e.g., "XYZ University"
  customLocation   String?   // e.g., "California"

  // Classification
  tier             String    // "reach" | "target" | "safety"
  isDream          Boolean   @default(false)  // Can be true for any tier

  // Interest Level
  interestLevel    String?   // "high" | "medium" | "low" | "uncertain"

  // Application Status
  status           String    @default("researching")
  // "researching" | "planning" | "in_progress" | "submitted" | "accepted" | "rejected" | "waitlisted" | "deferred" | "withdrawn" | "committed"

  // Application Type
  applicationType  String?   // "ed" | "ed2" | "ea" | "rea" | "rd"

  // Decision
  decisionDate     DateTime?
  financialAidOffered Int?

  // Student's Notes
  notes            String?
  whyInterested    String?   // Why this school
  concerns         String?   // Hesitations

  // Calculated
  calculatedChance Float?    // Our calculated admission probability
  chanceUpdatedAt  DateTime?

  // Display
  displayOrder     Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Unique constraint for linked schools only (custom schools use different uniqueness)
  @@unique([studentProfileId, schoolId])
  @@index([studentProfileId])
  @@index([status])

  // Relations - Rich notes (separate from simple 'notes' field above)
  richNotes SchoolNote[]
}

// -----------------------------------------------------------------------------
// SchoolNote - Rich text notes for a student's school
// -----------------------------------------------------------------------------

model SchoolNote {
  id              String   @id @default(uuid())
  studentSchoolId String
  studentSchool   StudentSchool @relation(fields: [studentSchoolId], references: [id], onDelete: Cascade)
  
  // Note Content
  title           String?           // Optional title for the note
  content         Json              // Rich text content (TipTap/Novel JSON format)
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([studentSchoolId])
  @@index([createdAt])
}

// -----------------------------------------------------------------------------
// Goals - Student's Objectives
// -----------------------------------------------------------------------------

model Goal {
  id               String @id @default(uuid())
  studentProfileId String
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)

  // Basic Info
  title        String
  description  String?

  // Classification
  category     String    // "research" | "competition" | "leadership" | "project" | "academic" | "application" | "other"

  // Status
  status       String    @default("planning")
  // "parking_lot" | "planning" | "in_progress" | "completed" | "abandoned"

  // Timing
  targetDate   DateTime?
  startedAt    DateTime?
  completedAt  DateTime?

  // Priority
  priority     String?   // "high" | "medium" | "low"

  // Impact
  impactDescription String?  // Why this matters for their application
  relatedPillar     String?  // "academics" | "activities" | "awards" | etc.

  // Source linking (for application goals auto-created from school/program list)
  schoolId          String?
  school            School?        @relation(fields: [schoolId], references: [id])
  summerProgramId   String?
  summerProgram     SummerProgram? @relation(fields: [summerProgramId], references: [id])
  isAutoGenerated   Boolean        @default(false)  // Created automatically when adding to list

  // Display
  displayOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tasks Task[]

  @@index([studentProfileId])
  @@index([status])
  @@index([schoolId])
  @@index([summerProgramId])
}

model Task {
  id               String @id @default(uuid())

  // Ownership - tasks can belong to a goal OR be standalone
  studentProfileId String
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  goalId           String?        // NOW OPTIONAL - tasks can exist without a goal
  goal             Goal?          @relation(fields: [goalId], references: [id], onDelete: Cascade)

  // Subtask Support (self-referencing)
  parentTaskId String?
  parentTask   Task?   @relation("TaskSubtasks", fields: [parentTaskId], references: [id], onDelete: Cascade)
  subtasks     Task[]  @relation("TaskSubtasks")

  // Task Info
  title       String
  description String?
  type        String    @default("action")   // "milestone" | "action"
                                             // milestone = informational date marker (no checkbox)
                                             // action = completable task

  // Status
  status      String    @default("pending")  // "pending" | "in_progress" | "completed" | "blocked"
  completed   Boolean   @default(false)      // Quick toggle (derived from status === "completed")
  completedAt DateTime?

  // Timing
  dueDate     DateTime?
  startDate   DateTime?

  // Priority
  priority    String?   // "high" | "medium" | "low"

  // ==========================================================================
  // SOURCE LINKING - For tasks created from school/program deadlines
  // ==========================================================================

  // What type of deadline is this?
  deadlineType      String?   // "early_decision" | "early_action" | "regular_decision" |
                              // "financial_aid" | "notification" | "commitment" |
                              // "program_application" | "program_early" | "program_notification" |
                              // "test_registration" | "test_date" | "custom"

  // Links to source entities (only one should be set)
  schoolId          String?
  school            School?        @relation(fields: [schoolId], references: [id])
  summerProgramId   String?
  summerProgram     SummerProgram? @relation(fields: [summerProgramId], references: [id])

  // For test deadlines
  testType          String?   // "sat" | "act" | "ap" | "sat_subject"

  // Metadata
  isAutoGenerated   Boolean   @default(false)  // Created from school/program data
  isHardDeadline    Boolean   @default(false)  // External deadline (can't be changed)
  reminderDays      Int?                       // Send reminder X days before

  // Order
  displayOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentProfileId])
  @@index([goalId])
  @@index([parentTaskId])
  @@index([schoolId])
  @@index([summerProgramId])
  @@index([dueDate])
}

// -----------------------------------------------------------------------------
// TaskTemplate - Pre-defined tasks for schools/programs
// -----------------------------------------------------------------------------
// Templates are used to pre-populate tasks when a student adds a school/program
// to their plan. They can be universal (apply to all) or specific to a program.

model TaskTemplate {
  id              String @id @default(uuid())

  // What this template applies to (null = universal template for all applications)
  schoolId        String?
  school          School?        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  summerProgramId String?
  summerProgram   SummerProgram? @relation(fields: [summerProgramId], references: [id], onDelete: Cascade)

  // Template content
  title           String
  description     String?
  type            String         @default("action")  // "milestone" | "action"
  category        String?        // "research" | "materials" | "submission" | "notification"

  // Timing - which deadline field to derive the date from, and offset
  // e.g., deadlineField="deadlineApplication", daysOffset=-7 means "7 days before app deadline"
  deadlineField   String?        // Field name on School/SummerProgram: "deadlineApplication", "deadlineEd", etc.
  daysOffset      Int            @default(0)  // Days before (negative) or after (positive) the deadline

  // Display
  displayOrder    Int            @default(0)
  isDefault       Boolean        @default(true)  // Show by default when importing

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([schoolId])
  @@index([summerProgramId])
}

// =============================================================================
// LAYER 4: AI & CONVERSATIONS
// =============================================================================

// -----------------------------------------------------------------------------
// Conversation - Chat Sessions
// -----------------------------------------------------------------------------

model Conversation {
  id               String @id @default(uuid())
  studentProfileId String
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)

  // Metadata
  title            String?   // Auto-generated or user-set
  mode             String?   // "general" | "chances" | "planning" | "schools" | "story" | "courses"

  // ==========================================================================
  // CONVERSATION SUMMARY (generated when conversation ends)
  // ==========================================================================

  // AI-facing summary (prose, injected into advisor context)
  summary          String?   @db.Text

  // User-facing summary (structured, for display in app or email)
  // Format: { headline, topicsDiscussed[], decisionsReached[], actionItems[] }
  summaryForUser   Json?

  summaryUpdatedAt DateTime?

  // ==========================================================================
  // LIFECYCLE
  // ==========================================================================

  startedAt        DateTime  @default(now())
  endedAt          DateTime?           // Set when conversation is closed
  lastMessageAt    DateTime?           // Updated on each message

  // Stats
  messageCount     Int       @default(0)

  // Metadata
  metadata         Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  messages Message[]

  @@index([studentProfileId])
  @@index([startedAt])
  @@index([lastMessageAt])  // For finding active conversations
}

// -----------------------------------------------------------------------------
// Message - Individual Chat Messages
// -----------------------------------------------------------------------------

model Message {
  id             String @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  // Message Content
  role           String    // "user" | "assistant" | "system"
  content        String
  
  // For assistant messages with tool calls
  toolCalls      Json?     // Array of tool calls made
  toolResults    Json?     // Results of tool executions
  
  // Widget data (for confirmation UI)
  widgetType     String?   // "gpa" | "sat" | "activity" | "award" | "school" | "goal" | "course"
  widgetData     Json?     // Structured data for the widget
  widgetStatus   String?   // "pending" | "confirmed" | "edited" | "dismissed"
  
  // Model info (for analytics/debugging)
  model          String?   // "claude-3-5-sonnet" | "gpt-4o" | "llama-3.1-70b"
  provider       String?   // "anthropic" | "openai" | "groq"
  tokensUsed     Int?
  latencyMs      Int?
  
  // Parsing results (from fast parser)
  parsedIntents  Json?     // What intents were detected
  parsedEntities Json?     // What entities were extracted
  
  createdAt DateTime @default(now())
  
  @@index([conversationId])
  @@index([createdAt])
}

// -----------------------------------------------------------------------------
// StudentContext - Master AI Context
// -----------------------------------------------------------------------------

model StudentContext {
  id               String @id @default(uuid())
  studentProfileId String @unique
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)

  // ==========================================================================
  // MASTER SUMMARY (updated after each conversation ends)
  // ==========================================================================

  // Quick context (~100 tokens) - used for welcome, fast operations
  // "Sarah Chen, junior at Lincoln High. 3.9 GPA, 1520 SAT. Targeting Stanford (ED), MIT."
  quickContext          String?   @db.Text

  // Recent sessions (~300 tokens) - detailed recent memory
  // "Last session (Jan 15): Made Stanford essay plan..."
  recentSessions        String?   @db.Text

  // Established understanding (~200 tokens) - stable facts about student
  // "Strengths: Strong STEM, robotics leadership. Concerns: Essay confidence."
  studentUnderstanding  String?   @db.Text

  // Active commitments (~100 tokens) - things to follow up on
  // "Stanford essay draft due Friday. MIT supplemental research in progress."
  openCommitments       String?   @db.Text

  masterSummaryUpdatedAt DateTime?

  // ==========================================================================
  // AI-GENERATED SESSION OBJECTIVES
  // ==========================================================================

  // Pre-generated objectives for the next conversation (AI-generated)
  // Updated on login, after conversation ends, or when profile changes significantly
  generatedObjectives   String?   @db.Text
  objectivesGeneratedAt DateTime?

  // Upcoming deadlines awareness (cached for quick access)
  // JSON array of { type, label, date, priority }
  upcomingDeadlines     Json?

  // ==========================================================================
  // ADVISOR PREFERENCES (student-configured)
  // ==========================================================================

  // Free-form description of how they want advisor to behave
  // "Be direct, don't sugarcoat. Push me on deadlines."
  advisorPreferences    String?   @db.Text

  // Accountability level: "gentle" | "moderate" | "intense"
  accountabilityLevel   String    @default("moderate")

  // ==========================================================================
  // LEGACY FIELDS (kept for compatibility, may deprecate)
  // ==========================================================================

  // Quick-access profile snapshot (for fast context loading)
  profileSnapshot       Json?     // Key facts: { gpa, sat, topActivities, etc. }
  snapshotUpdatedAt     DateTime?

  // Learned preferences (now partially replaced by advisorPreferences)
  communicationStyle    String?   // How they prefer to be talked to
  emotionalTendencies   String?   // "anxious" | "confident" | "needs_encouragement"
  preferredCheckInTime  String?   // "morning" | "evening"

  // Interaction stats
  totalConversations    Int       @default(0)
  totalMessages         Int       @default(0)
  lastConversationAt    DateTime?

  // Topics discussed
  topicsDiscussed       Json?     // Track what's been covered

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =============================================================================
// LAYER 5: ACCESS CONTROL
// =============================================================================

// -----------------------------------------------------------------------------
// AccessGrant - Sharing Permissions
// -----------------------------------------------------------------------------

model AccessGrant {
  id               String @id @default(uuid())
  studentProfileId String
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  
  // Who granted and who received
  grantedByUserId  String
  grantedBy        User   @relation("GrantedBy", fields: [grantedByUserId], references: [id])
  grantedToUserId  String
  grantedTo        User   @relation("GrantedTo", fields: [grantedToUserId], references: [id])
  
  // Permission level
  permission       String    // "view" | "comment" | "edit" | "admin"
  
  // What's shared
  scope            String    @default("full")  // "full" | "limited"
  scopeDetails     Json?     // If limited, what's included/excluded
  
  // Validity
  expiresAt        DateTime?
  revokedAt        DateTime?
  
  // Relationship type (for UI)
  relationship     String?   // "parent" | "counselor" | "tutor" | "other"
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([studentProfileId, grantedToUserId])
  @@index([grantedToUserId])
}

// -----------------------------------------------------------------------------
// Invitation - Pending Access Invitations
// -----------------------------------------------------------------------------

model Invitation {
  id               String @id @default(uuid())

  // Who sent the invitation
  inviterUserId    String
  inviter          User   @relation(fields: [inviterUserId], references: [id])

  // Which profile is being shared
  studentProfileId String
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)

  // Who is being invited (by email, since they may not have an account yet)
  inviteeEmail     String

  // Unique token for the invitation link
  token            String @unique

  // Status
  status           String @default("pending")  // "pending" | "accepted" | "expired" | "revoked"

  // Relationship type (for when the invitation is accepted)
  relationship     String?   // "parent" | "counselor" | "tutor" | "other"

  // Timestamps
  expiresAt        DateTime
  acceptedAt       DateTime?
  createdAt        DateTime @default(now())

  @@unique([studentProfileId, inviteeEmail])
  @@index([inviteeEmail])
  @@index([token])
}

// -----------------------------------------------------------------------------
// Organization - For Counselors (Future)
// -----------------------------------------------------------------------------

model Organization {
  id          String @id @default(uuid())
  
  name        String
  type        String    // "counseling_practice" | "high_school" | "tutoring_center"
  
  // Settings
  settings    Json?
  
  // Owner
  ownerUserId String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  members OrganizationMember[]
  studentLinks OrganizationStudentLink[]
}

model OrganizationMember {
  id             String @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User   @relation(fields: [userId], references: [id])
  
  role           String    // "owner" | "admin" | "counselor" | "assistant"
  
  createdAt DateTime @default(now())
  
  @@unique([organizationId, userId])
}

model OrganizationStudentLink {
  id               String @id @default(uuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  studentProfileId String
  
  // Assigned counselor within the org
  assignedCounselorId String?
  
  status           String    @default("active")  // "active" | "archived"
  
  // Counselor notes (private to org)
  notes            String?
  
  joinedAt DateTime @default(now())
  
  @@unique([organizationId, studentProfileId])
}

// =============================================================================
// LAYER 6: USAGE TRACKING & BILLING
// =============================================================================

// -----------------------------------------------------------------------------
// UsageRecord - Track AI Usage per User
// One record per user per day. Aggregated for billing/limits.
// -----------------------------------------------------------------------------

model UsageRecord {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Date (one record per day per user)
  date      DateTime @db.Date  // Just the date, no time
  
  // Usage counts
  messageCount    Int     @default(0)  // Number of messages sent
  tokensInput     Int     @default(0)  // Total input tokens
  tokensOutput    Int     @default(0)  // Total output tokens
  
  // Cost tracking (in USD, calculated from tokens + model rates)
  costAdvisor     Float   @default(0)  // Cost of advisor model usage
  costParser      Float   @default(0)  // Cost of parser model usage
  costOther       Float   @default(0)  // Cost of other models (chances, etc.)
  costTotal       Float   @default(0)  // Total cost for the day
  
  // Model breakdown (for analytics)
  modelUsage      Json?   // { "haiku": { tokens: 1000, cost: 0.01 }, ... }
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, date])
  @@index([userId])
  @@index([date])
}

// -----------------------------------------------------------------------------
// GlobalConfig - System-wide Configuration
// Single-row table for global settings (admin-configurable)
// -----------------------------------------------------------------------------

model GlobalConfig {
  id        String   @id @default("default")  // Always "default" - single row
  
  // ==========================================================================
  // TIER LIMITS
  // ==========================================================================
  
  // Free Tier
  freeDailyCostLimit    Float   @default(1.00)   // $1.00/day
  freeWeeklyCostLimit   Float   @default(5.00)   // $5.00/week
  freeMessageLimit      Int     @default(100)    // 100 messages/day
  
  // Standard Tier ($10/month)
  standardDailyCostLimit  Float   @default(1.00)   // $1.00/day
  standardWeeklyCostLimit Float   @default(5.00)   // $5.00/week
  standardMessageLimit    Int     @default(100)    // 100 messages/day
  
  // Premium Tier ($25/month)
  premiumDailyCostLimit   Float   @default(5.00)   // $5.00/day
  premiumWeeklyCostLimit  Float   @default(25.00)  // $25.00/week
  premiumMessageLimit     Int     @default(500)    // 500 messages/day
  
  // ==========================================================================
  // MODEL COSTS (per 1M tokens)
  // ==========================================================================
  
  // Anthropic Models (as of late 2025)
  costHaikuInput      Float   @default(0.25)    // $/1M input tokens
  costHaikuOutput     Float   @default(1.25)    // $/1M output tokens
  costSonnetInput     Float   @default(3.00)    // $/1M input tokens
  costSonnetOutput    Float   @default(15.00)   // $/1M output tokens
  costOpusInput       Float   @default(15.00)   // $/1M input tokens
  costOpusOutput      Float   @default(75.00)   // $/1M output tokens
  
  // Groq (for parser)
  costKimiK2Input     Float   @default(0.15)    // $/1M input tokens
  costKimiK2Output    Float   @default(0.40)    // $/1M output tokens
  
  // ==========================================================================
  // FEATURE FLAGS
  // ==========================================================================

  enableWidgets             Boolean @default(true)   // In-chat confirmation widgets
  enableChancesCalculation  Boolean @default(true)
  enableStoryMode           Boolean @default(true)
  enableSecretaryModel      Boolean @default(true)   // Use Kimi K2 as intelligent secretary
  
  // Maintenance mode
  maintenanceMode     Boolean @default(false)
  maintenanceMessage  String?

  updatedAt DateTime @updatedAt
}

// =============================================================================
// LAYER 7: RECOMMENDATIONS
// =============================================================================

// -----------------------------------------------------------------------------
// RecommendationPreferences - Student's recommendation preferences
// Semi-structured: free text organized by category
// -----------------------------------------------------------------------------

model RecommendationPreferences {
  id               String @id @default(uuid())
  studentProfileId String @unique
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)

  // Free-text preferences by category
  // "I'm interested in schools with strong engineering programs, preferably on the West Coast"
  schoolPreferences        String?   @db.Text

  // "I want programs that will help me with research experience, specifically in biology or medicine"
  programPreferences       String?   @db.Text

  // "I'd like to improve my leadership experience and find competitions in STEM"
  generalPreferences       String?   @db.Text

  // Location preferences
  preferredRegions         String[]  // ["West Coast", "Northeast", "Midwest"]
  avoidRegions             String[]  // Regions to avoid

  // Size preferences
  preferredSchoolSize      String?   // "small" | "medium" | "large" | "any"

  // Other filters
  requireNeedBlind         Boolean   @default(false)
  requireMeritScholarships Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// -----------------------------------------------------------------------------
// Recommendation - AI-generated recommendations
// Generated by specialized agents, consolidated by master agent
// -----------------------------------------------------------------------------

model Recommendation {
  id               String @id @default(uuid())
  studentProfileId String
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)

  // Category of recommendation
  category         String    // "school" | "program" | "activity" | "general"

  // What's being recommended
  title            String    // "Stanford University" | "RSI" | "Start a research project"
  subtitle         String?   // "Reach School" | "Summer 2025" | "High Priority"

  // Reference to existing entities (if applicable)
  schoolId         String?
  school           School?        @relation(fields: [schoolId], references: [id])
  summerProgramId  String?
  summerProgram    SummerProgram? @relation(fields: [summerProgramId], references: [id])

  // The recommendation content
  reasoning        String    @db.Text  // Why this is recommended
  fitScore         Float?    // 0.0 - 1.0 how well it fits the student
  priority         String?   // "high" | "medium" | "low"

  // Action items (optional)
  actionItems      String[]  // ["Research the program", "Check deadline: March 1"]

  // Timing context
  relevantGrade    String?   // "11th" | "12th" - when this is most relevant
  expiresAt        DateTime? // When recommendation is no longer relevant

  // Generation metadata
  generatedAt      DateTime  @default(now())
  generatedBy      String    // "school_agent" | "program_agent" | "master_agent"
  profileVersion   String?   // Hash/version of profile when generated

  // User interaction
  status           String    @default("active")  // "active" | "dismissed" | "saved" | "acted_upon"
  userFeedback     String?   // "helpful" | "not_relevant" | "already_knew"
  dismissedAt      DateTime?
  savedAt          DateTime?

  // Display order within category
  displayOrder     Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentProfileId])
  @@index([category])
  @@index([status])
  @@index([generatedAt])
}

// -----------------------------------------------------------------------------
// DataRequest - Requests for adding new programs/schools to the database
// Students can request items not in our curated database
// -----------------------------------------------------------------------------

model DataRequest {
  id               String   @id @default(uuid())

  // Who requested
  studentProfileId String
  studentProfile   StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)

  // What type of data
  type             String   // "program" | "school"

  // The name/details they provided
  name             String
  organization     String?  // For programs (e.g., "UCSB" for "UCSB SRA")
  details          Json?    // Additional info (year, type, url, etc.)

  // Request status
  status           String   @default("pending")  // "pending" | "approved" | "rejected" | "duplicate"

  // Admin response
  adminNotes       String?
  resolvedAt       DateTime?
  resolvedById     String?

  // If approved, link to created record
  createdRecordId  String?  // ID of the SummerProgram or School created

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([studentProfileId])
}

// =============================================================================
// LAYER 8: NOTIFICATIONS
// =============================================================================

// -----------------------------------------------------------------------------
// Notification - Proactive notifications sent to users
// Tracks all notifications sent by the LLM-based notification engine
// -----------------------------------------------------------------------------

model Notification {
  id              String   @id @default(uuid())

  // Recipient - always a User (could be student or parent)
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Recipient type context (for LLM and analytics)
  recipientType   String   // "student" | "parent" | "counselor"

  // What type of notification was this?
  type            String   // "deadline_reminder" | "encouragement" | "check_in" |
                           // "celebration" | "gentle_nudge" | "weekly_summary"

  // Channel(s) used
  channel         String   // "email" | "mobile" | "both"

  // Content - what was actually sent
  mobileMessage   String?              // Short message for push notification
  emailSubject    String?
  emailBody       String?  @db.Text    // Full email content

  // LLM decision context (for debugging and improvement)
  reasoning       String?  @db.Text    // Why the LLM decided to send this
  contextSnapshot Json?                // Snapshot of context used for decision

  // Delivery status
  status          String   @default("pending")  // "pending" | "sent" | "failed" | "skipped"
  sentAt          DateTime?
  failureReason   String?

  // For linking to what triggered the notification
  relatedGoalId   String?
  relatedTaskId   String?
  relatedSchoolId String?

  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([userId, createdAt])
  @@index([status])
  @@index([createdAt])
}
